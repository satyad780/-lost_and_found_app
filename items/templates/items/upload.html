{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Found Item</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'items/css/style.css' %}">

    <style>
        /* This forces the map to be visible */
        #map-canvas { 
            height: 400px !important; 
            width: 100%; 
            background: #222; 
            border-radius: 8px; 
            margin: 15px 0;
            border: 2px solid #444;
        }
        .form-box { max-width: 600px; margin: 0 auto; padding: 20px; color: white; }
        .hint { color: #10b981; font-weight: bold; display: block; margin-bottom: 5px; }
    </style>
</head>
<body style="background: #000;">
    <main>
        <div class="form-box">
            <h1>Report Found Item</h1>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <label>Item Name</label>
                <input type="text" name="name" class="form-control" required>

                <label>Your Name</label>
                <input type="text" name="finder_name" class="form-control" required>

                <label>Phone Number</label>
                <input type="text" name="finder_contact" class="form-control" required>

                <label>Category</label>
                <select name="category" class="form-control">
                    {% for v, l in categories %}
                        <option value="{{ v }}">{{ l }}</option>
                    {% endfor %}
                </select>

                <label>Description</label>
                <textarea name="description" class="form-control" required></textarea>

                <span class="hint">üìç Click map or drag pin to set location</span>
                <div id="map-canvas"></div>
                
                <input type="hidden" name="latitude" id="lat-input" value="23.2599">
                <input type="hidden" name="longitude" id="lng-input" value="77.4126">

                <label>Photo</label>
                <input type="file" name="image" class="form-control" required>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; margin-top: 20px;">SUBMIT REPORT</button>
            </form>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Start script only when window is fully loaded
        window.addEventListener('load', function() {
            var bplLat = 23.2599;
            var bplLng = 77.4126;

            // Init Map
            var myMap = L.map('map-canvas').setView([bplLat, bplLng], 13);

            // Add Tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(myMap);

            // Add Marker
            var myMarker = L.marker([bplLat, bplLng], {draggable: true}).addTo(myMap);

            function updateInputs(lt, lg) {
                document.getElementById('lat-input').value = lt;
                document.getElementById('lng-input').value = lg;
            }

            // Click Map
            myMap.on('click', function(e) {
                myMarker.setLatLng(e.latlng);
                updateInputs(e.latlng.lat, e.latlng.lng);
            });

            // Drag Pin
            myMarker.on('dragend', function(e) {
                var p = myMarker.getLatLng();
                updateInputs(p.lat, p.lng);
            });

            // Auto-detect
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var uLat = pos.coords.latitude;
                    var uLng = pos.coords.longitude;
                    myMap.setView([uLat, uLng], 15);
                    myMarker.setLatLng([uLat, uLng]);
                    updateInputs(uLat, uLng);
                });
            }
        });
    </script>
</body>
</html>